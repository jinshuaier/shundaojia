//
//  TCShierViewController.m
//  ShunDaoJia
//
//  Created by 吕松松 on 2017/12/14.
//  Copyright © 2017年 jinshuaier. All rights reserved.
//

#import "TCShierViewController.h"
#import "TCShirbalanceCell.h"
#import "TCThirdPayTableViewCell.h"
#import "DCPaymentView.h"
#import "TCResetViewController.h"
#import "TCPayOkViewController.h"
@interface TCShierViewController ()<UITableViewDelegate,UITableViewDataSource,UIScrollViewDelegate>
@property (nonatomic, strong) UITableView *mainTableView;
@property (nonatomic, strong) NSArray *imageS;
@property (nonatomic, strong) NSArray *titleS;
@property (nonatomic, strong) DCPaymentView *payAlertView;
@property (nonatomic, strong) NSString *source;
@property (nonatomic, strong) NSUserDefaults *userdefaults;
@property (nonatomic, strong) NSString *banlanceStr;
@property (nonatomic, strong) NSString *password;
@property (nonatomic, strong) NSString *banlanceid;
@property (nonatomic, strong) NSString *sourceid;

@end

@implementation TCShierViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.title = @"顺道嘉收银台";
    self.userdefaults = [NSUserDefaults standardUserDefaults];
    self.view.backgroundColor = TCBgColor;
    [self creatRequest];
    [self creatUI];
    // Do any additional setup after loading the view.
}

-(void)creatRequest{
    [BQActivityView showActiviTy];
    //请求接口
    NSString *timeStr = [TCGetTime getCurrentTime];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userToken"]];
    NSDictionary *dic = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr};
    NSLog(@"%@",dic);
    NSString *signStr = [TCServerSecret signStr:dic];
    
    NSDictionary *paramters = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"sign":signStr};
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"101011"] paramter:paramters success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        self.banlanceStr = [NSString stringWithFormat:@"%@",jsonDic[@"data"]];
        [self.mainTableView reloadData];
        [self request];
    } failure:^(NSError *error) {
        
    }];
    [BQActivityView hideActiviTy];
}
//请求是否设置了密码
-(void)request{
    [BQActivityView showActiviTy];
    //请求接口
    NSString *timeStr = [TCGetTime getCurrentTime];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userToken"]];
    NSDictionary *dic = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr};
    NSLog(@"%@",dic);
    NSString *signStr = [TCServerSecret signStr:dic];
    NSDictionary *paramters = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"sign":signStr};
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"102013"] paramter:paramters success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        NSString *payStr = [NSString stringWithFormat:@"%@",jsonDic[@"data"][@"is_pay"]];
        if ([payStr isEqualToString:@"1"]) {
            self.isSet = YES;
        }else{
            self.isSet = NO;
        }
    
    } failure:^(NSError *error) {
        
    }];
    [BQActivityView hideActiviTy];
    
}
-(void)creatUI{
    self.imageS = @[@"微信支付",@"支付宝支付",@"银联支付"];
    self.titleS = @[@"微信支付",@"支付宝支付",@"银行卡支付"];
    UIView *headView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, WIDTH, 180 + 48 + 1)];
    headView.backgroundColor = TCBgColor;
    [self.view addSubview:headView];
    
    UIView *picView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, WIDTH, 180)];
    picView.backgroundColor = TCUIColorFromRGB(0xFFFFFF);
    [headView addSubview:picView];
    
//    UIImageView *pic = [[UIImageView alloc]initWithFrame:CGRectMake(12, 8, WIDTH - 24, 84)];
//    pic.image = [UIImage imageNamed:@"4"];
//    [picView addSubview:pic];
    UIScrollView *picScrllView = [[UIScrollView alloc]initWithFrame:CGRectMake(12, 8, WIDTH - 24, 84)];
    picScrllView.contentSize = CGSizeMake((WIDTH - 24)*3, 84);
    picScrllView.scrollEnabled = YES;
    picScrllView.showsHorizontalScrollIndicator = YES;
    picScrllView.delegate = self;
    [picView addSubview:picScrllView];
    
    UIImageView *pic1 = [[UIImageView alloc]initWithFrame:CGRectMake(0, 0,WIDTH - 24, 84)];
    pic1.image = [UIImage imageNamed:@"1"];
    [picScrllView addSubview:pic1];
    
    UIImageView *pic2 = [[UIImageView alloc]initWithFrame:CGRectMake(WIDTH - 24, 0, WIDTH - 24, 84)];
    pic2.image = [UIImage imageNamed:@"3"];
    [picScrllView addSubview:pic2];
    
    UIImageView *pic3 = [[UIImageView alloc]initWithFrame:CGRectMake((WIDTH - 24)*2, 0, WIDTH - 24, 84)];
    pic2.image = [UIImage imageNamed:@"4"];
    [picScrllView addSubview:pic3];
    
    
    
    UILabel *timeLabel = [[UILabel alloc]initWithFrame:CGRectMake((WIDTH - 72)/2, CGRectGetMaxY(picScrllView.frame) + 16, 72, 16)];
    timeLabel.text = @"支付剩余时间";
    timeLabel.font = [UIFont fontWithName:@"PingFangSC-Regular" size:12];
    timeLabel.textColor = TCUIColorFromRGB(0x4C4C4C);
    timeLabel.textAlignment = NSTextAlignmentLeft;
    [picView addSubview:timeLabel];
    
    UILabel *TimeStr = [[UILabel alloc]initWithFrame:CGRectMake((WIDTH - 82)/2, CGRectGetMaxY(timeLabel.frame) + 8, 82, 30)];
    TimeStr.text = @"30:00";
    TimeStr.font = [UIFont fontWithName:@"PingFangSC-Medium" size:30];
    TimeStr.textColor = TCUIColorFromRGB(0x666666);
    TimeStr.textAlignment = NSTextAlignmentLeft;
    [picView addSubview:TimeStr];
    
    UIView *payView = [[UIView alloc]initWithFrame:CGRectMake(0, CGRectGetMaxY(picView.frame) + 1, WIDTH, 48)];
    payView.backgroundColor = TCUIColorFromRGB(0xFFFFFF);
    [headView addSubview:payView];
    
    UIImageView  *shopImage = [[UIImageView alloc]initWithFrame:CGRectMake(12, 12, 24, 24)];
    shopImage.image = [UIImage imageNamed:@"1-1"];
    [payView addSubview:shopImage];
    
    UILabel *shopName = [[UILabel alloc]initWithFrame:CGRectMake(CGRectGetMaxX(shopImage.frame) + 8, 14, WIDTH - 24 - 44 - 75, 20)];
    shopName.text = @"顺道嘉超市金融街园中园店";
    shopName.font = [UIFont fontWithName:@"PingFangSC-Regular" size:14];
    shopName.textColor = TCUIColorFromRGB(0x4D4D4D);
    shopName.textAlignment = NSTextAlignmentLeft;
    [payView addSubview:shopName];

    UILabel *payMoney = [[UILabel alloc]initWithFrame:CGRectMake(WIDTH - 12 - 75, 15, 75, 18)];
    payMoney.text = @"需支付￥888";
    payMoney.font = [UIFont fontWithName:@"PingFangSC-Regular" size:12];
    payMoney.textColor = TCUIColorFromRGB(0x4C4C4C);
    payMoney.textAlignment = NSTextAlignmentRight;
    [payView addSubview:payMoney];
    
    self.mainTableView = [[UITableView alloc]initWithFrame:CGRectMake(0, 1 + StatusBarAndNavigationBarHeight, WIDTH, HEIGHT - 48 - 56) style:(UITableViewStyleGrouped)];
    self.mainTableView.delegate = self;
    self.mainTableView.dataSource = self;
    self.mainTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    self.mainTableView.backgroundColor = TCBgColor;
    [self.view addSubview:self.mainTableView];
    self.mainTableView.tableHeaderView = headView;
    
    UIButton *surePay = [[UIButton alloc]initWithFrame:CGRectMake(0, HEIGHT - 48, WIDTH, 48)];
    [surePay setBackgroundColor:TCUIColorFromRGB(0xF99E20)];
    [surePay setTitle:@"确认支付" forState:(UIControlStateNormal)];
    [surePay setTitleColor:TCUIColorFromRGB(0xFFFFFF) forState:(UIControlStateNormal)];
    [surePay addTarget:self action:@selector(clickPay:) forControlEvents:(UIControlEventTouchUpInside)];
    surePay.titleLabel.font = [UIFont fontWithName:@"PingFangSC-Medium" size:16];
    surePay.titleLabel.textAlignment = NSTextAlignmentCenter;
    [self.view addSubview:surePay];
    
    self.source = @"100";

}

-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 2;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 0) {
        return 1;
    }else{
        return 2;
    }
}

//预防ios11错误
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section {
    if (section == 0) {
        UIView *headerView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, self.view.qh_width, 42)];
        headerView.backgroundColor = TCBgColor;
        UILabel *title = [[UILabel alloc]initWithFrame:CGRectMake(12, 12, 56, 18)];
        title.text = @"支付方式";
        title.font = [UIFont fontWithName:@"PingFangSC-Regular" size:14];
        title.textColor = TCUIColorFromRGB(0x4C4C4C);
        title.textAlignment = NSTextAlignmentLeft;
        [headerView addSubview:title];
        return headerView;
    }else if (section == 1){
        UIView *headerView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, self.view.qh_width, 42)];
        headerView.backgroundColor = TCBgColor;
        UILabel *title = [[UILabel alloc]initWithFrame:CGRectMake(12, 12, 84, 18)];
        title.text = @"其他支付方式";
        title.font = [UIFont fontWithName:@"PingFangSC-Regular" size:14];
        title.textColor = TCUIColorFromRGB(0x4C4C4C);
        title.textAlignment = NSTextAlignmentLeft;
        [headerView addSubview:title];
        return headerView;
    }
    return nil;
}
-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        return 72;
    }else{
        return 56;
    }
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return 42;
}
-(CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return 0;
}
- (UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section {
    return [[UIView alloc] init];
}

-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0) {
        TCShirbalanceCell *cell = [[TCShirbalanceCell alloc]initWithStyle:(UITableViewCellStyleDefault) reuseIdentifier:@"cell1"];
        cell.balanceLabel.text = [NSString stringWithFormat:@"余额：￥%@",self.banlanceStr];
        cell.checkBtn.tag = 105;
        cell.checkBtn.selected = YES;
        [cell.checkBtn addTarget:self action:@selector(clickBtn:) forControlEvents:(UIControlEventTouchUpInside)];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        return cell;
    }else if(indexPath.section == 1){
        TCThirdPayTableViewCell *cell = [[TCThirdPayTableViewCell alloc]initWithStyle:(UITableViewCellStyleDefault) reuseIdentifier:@"cell"];
            cell.iconImage.image = [UIImage imageNamed:self.imageS[indexPath.row]];
            cell.nameLabel.text = self.titleS[indexPath.row];
        cell.checkBtn.tag = 100 + indexPath.row;
        [cell.checkBtn addTarget:self action:@selector(clickBtn:) forControlEvents:(UIControlEventTouchUpInside)];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        return cell;
    }
    return nil;
}

-(void)clickBtn:(UIButton *)sender{
    sender.selected = !sender.selected;
    UIButton *btn1 = (UIButton *)[self.view viewWithTag:100];
    UIButton *btn2 = (UIButton *)[self.view viewWithTag:101];
    UIButton *btn3 = (UIButton *)[self.view viewWithTag:102];
    UIButton *btn5 = (UIButton *)[self.view viewWithTag:105];
    if (sender.tag == 100) {
        self.source = @"3";
        btn2.selected = NO;
        btn3.selected = NO;
        btn5.selected = NO;
    }else if (sender.tag == 101){
        self.source = @"2";
        btn1.selected = NO;
        btn3.selected = NO;
        btn5.selected = NO;
    }else if(sender.tag == 102){
        btn1.selected = NO;
        btn2.selected = NO;
        btn5.selected = NO;
    }else{
        self.source = @"100";
        btn1.selected = NO;
        btn2.selected = NO;
        btn3.selected = NO;
    }
}

-(void)clickPay:(UIButton *)sender{
    NSLog(@"%@",self.source);
    if ([self.source isEqualToString:@"100"]) {
        if (self.isSet == YES) {
            NSLog(@"该挑出键盘了");
            self.payAlertView = [[DCPaymentView alloc]init];
            self.payAlertView.title = @"输入支付密码";
            [self.payAlertView.forgetBtn addTarget:self action:@selector(clickClose:) forControlEvents:(UIControlEventTouchUpInside)];
            
            [self.payAlertView show];
            self.payAlertView.completeHandle = ^(NSString *inputPwd) {
                NSLog(@"密码是%@",inputPwd);
                [TCProgressHUD showMessage:@"支付成功"];
                if (inputPwd.length == 6) {
                    self.password = [NSString stringWithFormat:@"%@",inputPwd];
                    [self payRequest];
                }
            };
        }else{
            UIAlertView *alert = [[UIAlertView alloc]initWithTitle:nil message:@"为了您的账户安全请先设置支付密码" delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"设置密码", nil];
            [alert show];
        }
    }else if ([self.source isEqualToString:@"3"]){
        NSLog(@"跳到微信支付");
        [self tirdRequest];
    }else if ([self.source isEqualToString:@"2"]){
        NSLog(@"跳到支付宝支付");
        [self tirdRequest];
    }
}

-(void)payRequest{
    [BQActivityView showActiviTy];
    //请求接口
    NSString *timeStr = [TCGetTime getCurrentTime];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userToken"]];
    NSDictionary *dic = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"payCode":self.password};
    NSLog(@"%@",dic);
    NSString *signStr = [TCServerSecret signStr:dic];
    
    NSDictionary *paramters = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"sign":signStr,@"payCode":self.password};
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"101012"] paramter:paramters success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        NSLog(@"%@,%@",jsonDic,jsonStr);
        NSString *codeStr = [NSString stringWithFormat:@"%@",jsonDic[@"code"]];
        if ([codeStr isEqualToString:@"1"]) {
            [TCProgressHUD showMessage:@"支付成功"];
            [self creatPayRequest];
//            TCPayOkViewController *payOk = [[TCPayOkViewController alloc]init];
//            [self.navigationController pushViewController:payOk animated:YES];
        }else{
            [TCProgressHUD showMessage:[NSString stringWithFormat:@"%@",jsonDic[@"msg"]]];
        }
        [BQActivityView hideActiviTy];
        //成功后返回更新
    } failure:^(NSError *error) {
        nil;
    }];
}

-(void)creatPayRequest{
    [BQActivityView showActiviTy];
    //请求接口
    NSString *timeStr = [TCGetTime getCurrentTime];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userToken"]];
    NSString *orderid = self.orderid;
    NSString *remark = @"支付";
    NSString *terminal = @"IOS";
    NSString *mmdid = [TCGetDeviceId getDeviceId];
    NSString *deviceid = [TCDeviceName getDeviceName];
    
    NSDictionary *dic = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"source":self.source,@"orderid":orderid,@"deviceid":deviceid,@"terminal":terminal,@"mmdid":mmdid,@"remark":remark};
    NSLog(@"%@",dic);
    NSString *signStr = [TCServerSecret signStr:dic];
    NSDictionary *paramers = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"source":self.source,@"orderid":orderid,@"deviceid":deviceid,@"terminal":terminal,@"mmdid":mmdid,@"remark":remark,@"sign":signStr};
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"104010"] paramter:paramers success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        NSLog(@"%@--%@",jsonDic,jsonStr);
        NSString *codeStr = [NSString stringWithFormat:@"%@",jsonDic[@"code"]];
        if ([codeStr isEqualToString:@"1"]) {
            if ([self.source isEqualToString:@"100"]) {
                [TCProgressHUD showMessage:@"支付成功"];
                TCPayOkViewController *payOk = [[TCPayOkViewController alloc]init];
                [self.navigationController pushViewController:payOk animated:YES];
            }else{
                
            }
            
        }else{
            [TCProgressHUD showMessage:[NSString stringWithFormat:@"%@",jsonDic[@"msg"]]];
        }
        [BQActivityView hideActiviTy];
    } failure:^(NSError *error) {
        nil;
    }];
}

-(void)tirdRequest{
    [Pingpp setDebugMode:YES];
    //
    [TCProgressHUD showMessage:@"支付中..."];
    UITextField *field = (UITextField *)[self.view viewWithTag:201];
    NSString *timeStr = [TCGetTime getCurrentTime];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userToken"]];
    NSString *remark = @"支付";
    NSString *terminal = @"IOS";
    NSString *mmdid = [TCGetDeviceId getDeviceId];
    NSString *deviceid = [TCDeviceName getDeviceName];
    NSDictionary *dic = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"source":self.source,@"orderid":self.orderid,@"deviceid":deviceid,@"terminal":terminal,@"mmdid":mmdid,@"remark":remark};
    NSLog(@"%@",dic);
    NSString *signStr = [TCServerSecret signStr:dic];
    
    NSDictionary *paramters = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"source":self.source,@"orderid":self.orderid,@"deviceid":deviceid,@"terminal":terminal,@"mmdid":mmdid,@"remark":remark,@"sign":signStr};
    
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"104010"] paramter:paramters success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        NSLog(@"%@,%@",jsonDic,jsonStr);
        
        [Pingpp createPayment:jsonDic[@"data"][@"alipay"] appURLScheme:@"moumou" withCompletion:^(NSString *result, PingppError *error) {
            NSLog(@"%@-----",result);
            if ([result isEqualToString:@"success"]) {
                [TCProgressHUD showMessage:@"支付成功"];
                NSString *balancebillsid = [NSString stringWithFormat:@"%@",jsonDic[@"data"][@"balancebillsid"]];
                self.banlanceid = balancebillsid;
                self.sourceid = [NSString stringWithFormat:@"%@",jsonDic[@"data"][@"sourceid"]];
                [self updatastate];
                
                
            }else{
                [TCProgressHUD showMessage:@"支付失败"];
            }
        }];
        
    } failure:^(NSError *error) {
        nil;
    }];
}

-(void)updatastate{
    NSString *timeStr = [TCGetTime getCurrentTime];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userdefaults valueForKey:@"userToken"]];
    NSString *banid = [NSString stringWithFormat:@"%@",self.banlanceid];
    NSDictionary *dic2 = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"balancebillsid":banid,@"sourceid":self.sourceid};
    NSString *signStr = [TCServerSecret signStr:dic2];
    NSDictionary *para = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"balancebillsid":banid,@"sourceid":self.sourceid,@"sign":signStr};
    NSLog(@"para :%@",para);
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"104011"] paramter:para success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        NSLog(@"%@%@",jsonStr,jsonDic);
        NSLog(@"支付成功了？");
        NSString *codeStr = [NSString stringWithFormat:@"%@",jsonDic[@"code"]];
        if ([codeStr isEqualToString:@"1"]) {
            
                [TCProgressHUD showMessage:@"支付成功"];
                TCPayOkViewController *payOk = [[TCPayOkViewController alloc]init];
                [self.navigationController pushViewController:payOk animated:YES];
            }else{
                
            }
        
        
    } failure:^(NSError *error) {
        
    }];
}

-(void)clickClose:(UIButton *)sender{
    TCResetViewController *reseVC = [[TCResetViewController alloc]init];
    [self.navigationController pushViewController:reseVC animated:YES];
    
}

- (void)viewWillDisappear:(BOOL)animated{
    [self.payAlertView dismiss];
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
