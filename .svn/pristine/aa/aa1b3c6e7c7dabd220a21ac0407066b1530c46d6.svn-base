//
//  TCSubmitViewController.m
//  ShunDaoJia
//
//  Created by 胡高广 on 2017/12/14.
//  Copyright © 2017年 jinshuaier. All rights reserved.
//

#import "TCSubmitViewController.h"
#import "TCSeleAdressTableViewCell.h"
#import "TCOrderGoodsTableViewCell.h"
#import "TCSpecialTableViewCell.h"
#import "TCPaymentTableViewCell.h"
#import "TCReaddressViewController.h"
#import "TCReaddressInfo.h"
#import "TCShopDataBase.h"
#import "TCGroupDataBase.h"
#import "TCGoodsInfo.h"
#import "TCShierViewController.h"  //支付

@interface TCSubmitViewController ()<UITableViewDelegate,UITableViewDataSource,tapkeyWordDelegete,adressDelegate>
@property (nonatomic, strong) UITableView *listTabelView;
@property (nonatomic, strong) NSString *nameStr; //姓名
@property (nonatomic, strong) NSString *telStr; //电话
@property (nonatomic, strong) NSString *adressStr; //地址
@property (nonatomic, strong) NSDictionary *adressDic; //地址传值

@property (nonatomic, strong) TCShopDataBase *shopDase; //查询数据库
@property (nonatomic, strong) TCGroupDataBase *groupDase;
@property (nonatomic, strong) NSMutableArray *shopGoodsArray;
@property (nonatomic, strong) NSMutableArray *hongbaoArray; //红包的优惠券的数组
@property (nonatomic, strong) NSMutableArray *activeArr; //活动的数组
@property (nonatomic, strong) NSArray *shopArr;
@property (nonatomic, strong) NSUserDefaults *userDefaults;
@property (nonatomic, strong) NSString *allP; //总价
@property (nonatomic, strong) NSString *numGoods; //商品数量
@property (nonatomic, strong) NSString *goodTypes; //商品类型
@property (nonatomic, strong) NSString *remarkStr;
@property (nonatomic, strong) UIView *headView;
@property (nonatomic, strong) NSString *allPrice; //无论有无优惠的总价格
@property (nonatomic, strong) NSString *timeStr; //时间
@end

@implementation TCSubmitViewController

- (void)viewWillAppear:(BOOL)animated{
    
    [super viewWillAppear:animated];
    [self.navigationController setNavigationBarHidden:NO animated:NO];
    //通知回传的地址
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(getadd:) name:@"shopbackaddress" object:nil];
    //通知回传的备注信息
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(remake:) name:@"remakeNoti" object:nil];
    
    //请求商品详情啊
    [self createGoodsDis];
}

//备注信息
- (void)remake:(NSNotification *)not
{
    NSLog(@"%@",not.userInfo);
    self.remarkStr = not.userInfo[@"remak"];
}

- (void)viewDidLoad {
    [super viewDidLoad];
    self.view.backgroundColor = TCBgColor;
    self.title = @"提交订单";
    self.shopGoodsArray = [NSMutableArray array];
    self.activeArr = [NSMutableArray array];
    self.hongbaoArray = [NSMutableArray array];
    self.userDefaults = [NSUserDefaults standardUserDefaults];
    
    //再来一单传过来的
    if (self.agianDic){
        //再来一单传过来的
        self.adressDic = self.agianDic[@"address"];
        self.remarkStr = self.agianDic[@"remark"];
        
        NSArray *agianArr = self.agianDic[@"goods"];
        for (int i = 0; i < agianArr.count; i++) {
            TCGoodsInfo *model = [TCGoodsInfo orderInfoWithDictionary:agianArr[i] andType:@"3"];
            [self.shopGoodsArray addObject:model];
        }
    } else {   //普通商超和团购
        //0 是 普通订单, 1 是 团购
        if ([self.typeStr isEqualToString:@"0"]){
            //初始化数据库
            self.shopDase = [[TCShopDataBase alloc] initTCDataBase];
        } else {
            self.groupDase = [[TCGroupDataBase alloc] initTCDataBase];
        }
        //遍历数据库
        if ([self.typeStr isEqualToString:@"0"]){
            self.shopArr = [self.shopDase bianliFMDB:self.shopIDStr];
        } else {
            self.shopArr = [self.groupDase bianliFMDB:self.shopIDStr];
        }
    
            //普通商超和团购
            for (int i = 0; i < _shopArr.count; i++) {
                TCGoodsInfo *model = [TCGoodsInfo orderInfoWithDictionary:_shopArr[i] andType:@"1"];
                [self.shopGoodsArray addObject:model];
            }
    }
    
    //创建历史记录的tableView
    self.listTabelView = [[UITableView alloc]initWithFrame:CGRectMake(0, StatusBarAndNavigationBarHeight, WIDTH, HEIGHT - StatusBarAndNavigationBarHeight - TabbarSafeBottomMargin - 48) style:UITableViewStyleGrouped];
    self.listTabelView.delegate = self;
    self.listTabelView.dataSource = self;
    self.listTabelView.backgroundColor = TCBgColor;
    self.listTabelView.separatorStyle = UITableViewCellSeparatorStyleNone;
    [self.view addSubview: self.listTabelView];
    //解决ios11的导航栏布局的问
    AdjustsScrollViewInsetNever (self,self.listTabelView);

    // Do any additional setup after loading the view.
}

#pragma mark -- 店铺活动的接口
- (void)createShopDiscounts
{
    [self.activeArr removeAllObjects];
    CGFloat x = 0.0;
    int y = 0;
    //获取商品的总价格
    for (int i = 0; i < self.shopArr.count ; i++) {
        float price = 0.0;
        if ([self.shopArr[i][@"shopSpec"] isEqualToString:@""]) {
            price = [self.shopArr[i][@"shopPrice"] floatValue];
        } else {
            price = [self.shopArr[i][@"shopSpecPrice"] floatValue];
        }
        x += [self.shopArr[i][@"shopCount"] floatValue] * price;
        y += [self.shopArr[i][@"shopCount"] intValue];
    }
    self.allP = [NSString stringWithFormat:@"%.2f", x];
    
    //请求接口
    NSString *timeStr = [TCGetTime getCurrentTime];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userDefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userDefaults valueForKey:@"userToken"]];
    
    NSDictionary *dic = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"shopid":self.shopIDStr,@"order_money":self.allP};
    NSLog(@"%@",dic);
    NSString *signStr = [TCServerSecret signStr:dic];
    NSDictionary *paramers = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"shopid":self.shopIDStr,@"order_money":self.allP,@"sign":signStr};
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"102016"] paramter:paramers success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        if (jsonDic[@"data"]){
             [self.activeArr addObject:jsonDic[@"data"]];
        } else {
            NSLog(@"无活动");
        }
        NSLog(@"%@--%@",jsonDic,jsonStr);
        //请求红包的接口
        [self createHongBao];
        [self.listTabelView reloadData];
        
    } failure:^(NSError *error) {
        nil;
    }];
}

#pragma mark -- 请求红包的接口
- (void) createHongBao
{
    [self.hongbaoArray removeAllObjects];
    CGFloat x = 0.0;
    int y = 0;
    CGFloat h = 0.0;
    //获取商品的总价格
    for (int i = 0; i < self.shopArr.count ; i++) {
        float price = 0.0;
        if ([self.shopArr[i][@"shopSpec"] isEqualToString:@""]) {
            price = [self.shopArr[i][@"shopPrice"] floatValue];
        } else {
            price = [self.shopArr[i][@"shopSpecPrice"] floatValue];
        }
        x += [self.shopArr[i][@"shopCount"] floatValue] * price;
        y += [self.shopArr[i][@"shopCount"] intValue];
    }
    NSString *peisongStr;
    //团购进来的
    peisongStr = self.orderDisDic[@"data"][@"distributionPrice"];
    h = [peisongStr floatValue];
    self.allPrice = [NSString stringWithFormat:@"%.2f", x+h];
    
    //请求接口
    NSString *timeStr = [TCGetTime getCurrentTime];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userDefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userDefaults valueForKey:@"userToken"]];
    
    NSDictionary *dic = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"money":self.allPrice};
    NSLog(@"%@",dic);
    NSString *signStr = [TCServerSecret signStr:dic];
    NSDictionary *paramers = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"money":self.allPrice,@"sign":signStr};
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"102025"] paramter:paramers success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        NSLog(@"%@--%@",jsonDic,jsonStr);
        NSArray *arr = jsonDic[@"data"];
        
        for (NSDictionary *dic in arr) {
            [self.hongbaoArray addObject:dic];
        }
        //底部的view
        [self createBottomView];
        NSLog(@"--这里是红包的接口%@",self.hongbaoArray);
        [self.listTabelView reloadData];
        
    } failure:^(NSError *error) {
        nil;
    }];
}


//选择地址返回信息
- (void)getadd:(NSNotification *)not{
    
    self.adressDic = not.userInfo[@"addarr"];
  // [self.listTabelView reloadData];
}

//订单详情的接口啊
- (void)createGoodsDis
{
    [ProgressHUD showHUDToView:self.view];
    //请求接口
    NSString *timeStr = [TCGetTime getCurrentTime];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userDefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userDefaults valueForKey:@"userToken"]];
    
    NSDictionary *dic = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"shopid":self.shopIDStr};
    NSLog(@"%@",dic);
    NSString *signStr = [TCServerSecret signStr:dic];
    NSDictionary *paramers = @{@"mid":midStr,@"token":tokenStr,@"timestamp":timeStr,@"shopid":self.shopIDStr,@"sign":signStr};
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"101005"] paramter:paramers success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        NSLog(@"%@--%@",jsonDic,jsonStr);
        if ([self.typeStr isEqualToString:@"1"]){
            
        } else {
            self.orderDisDic = jsonDic[@"data"];
        }
        //下单时可以使用的店铺优惠的接口
        [self createShopDiscounts];
        
        [self.listTabelView reloadData];

        [ProgressHUD hiddenHUD:self.view];
    } failure:^(NSError *error) {
        nil;
    }];
}

//创建底部的View
- (void)createBottomView
{
    UIView *bottomView = [[UIView alloc] init];
    bottomView.backgroundColor = TCUIColorFromRGB(0xFFFFFF);
    bottomView.frame = CGRectMake(0, HEIGHT - 48, WIDTH, 48);
    [self.view addSubview:bottomView];
    
    //再来一单传过来的
    if (self.agianDic){
        CGFloat x = 0.0;
        CGFloat h = 0.0;
        int y = 0;
        NSArray *arr = self.agianDic[@"goods"];
        for (int i = 0; i < arr.count; i++) {
        
            float price = [arr[i][@"price"] floatValue];
            
            x += [arr[i][@"amount"] floatValue] * price;
            y += [arr[i][@"amount"] intValue];
        }
        if (self.agianDic[@"distributionPrice"] != nil){
            
            h = [self.agianDic[@"distributionPrice"] floatValue] + x;
            self.allP = [NSString stringWithFormat:@"%.2f", h];
        } else {
            self.allP = [NSString stringWithFormat:@"%.2f", x];
        }
        
        self.numGoods = [NSString stringWithFormat:@"%d",y];
        self.goodTypes = [NSString stringWithFormat:@"%lu", (unsigned long)arr.count];
        //再来一单传过来的
        self.adressDic = self.agianDic[@"address"];
        self.remarkStr = self.agianDic[@"remark"];
    } else {
        // 商超或者团购
        CGFloat x = 0.0;
        int y = 0;
        CGFloat h = 0.0;
        CGFloat m = 0.0; //满减优惠的
        //获取商品的总价格
        for (int i = 0; i < self.shopArr.count ; i++) {
            float price = 0.0;
            if ([self.shopArr[i][@"shopSpec"] isEqualToString:@""]) {
                price = [self.shopArr[i][@"shopPrice"] floatValue];
            } else {
                price = [self.shopArr[i][@"shopSpecPrice"] floatValue];
            }
            x += [self.shopArr[i][@"shopCount"] floatValue] * price;
            y += [self.shopArr[i][@"shopCount"] intValue];
        }
        //团购进来的
        
        NSString *peisongStr = self.orderDisDic[@"data"][@"distributionPrice"];
        h = [peisongStr floatValue];
        //有满减优惠
        NSString *manjianStr;
        if (self.activeArr.count != 0){
            manjianStr = self.activeArr[0][@"reduce"];  //满减的价格
        } else {
            NSLog(@"暂时未知");
            manjianStr = @"0";
        }
        
        m = [manjianStr floatValue];
        self.allP = [NSString stringWithFormat:@"%.2f", x+h-m];
    }
    //金额
    UILabel *moneyTitleLabel = [UILabel publicLab:[NSString stringWithFormat:@"金额：¥%@",self.allP] textColor:TCUIColorFromRGB(0x4C4C4C) textAlignment:NSTextAlignmentLeft fontWithName:@"PingFangSC-Medium" size:16 numberOfLines:0];
    [self fuwenbenLabel:moneyTitleLabel FontNumber:[UIFont fontWithName:@"PingFangSC-Semibold" size:16] AndRange:NSMakeRange(3, self.allP.length + 1) AndColor:TCUIColorFromRGB(0xFF3355)];
    moneyTitleLabel.frame = CGRectMake(18, 0, WIDTH - 120, 48);
    [bottomView addSubview:moneyTitleLabel];
    
    //去支付按钮
    UIButton *goPayBtn = [UIButton buttonWithType:(UIButtonTypeCustom)];
    goPayBtn.frame = CGRectMake(WIDTH - 120, 0, 120, 48);
    goPayBtn.backgroundColor = TCUIColorFromRGB(0xF99E20);
    [goPayBtn setTitle:@"去支付" forState:(UIControlStateNormal)];
    [goPayBtn setTitleColor:TCUIColorFromRGB(0xFFFFFF) forState:(UIControlStateNormal)];
    goPayBtn.titleLabel.font = [UIFont fontWithName:@"PingFangSC-Medium" size:16];
    [goPayBtn addTarget:self action:@selector(goPat:) forControlEvents:(UIControlEventTouchUpInside)];
    [bottomView addSubview:goPayBtn];
}
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 4;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    if (section == 1){
        return self.shopGoodsArray.count;
    } else if (section == 2){
        if (self.hongbaoArray.count != 0 && self.activeArr.count != 0){
            return self.activeArr.count + 1 + 1 + 1; //配送费
        } else if (self.hongbaoArray.count == 0 && self.activeArr.count != 0){
            return self.activeArr.count + 1 + 1;
        } else if (self.hongbaoArray.count != 0 && self.activeArr.count == 0){
            return 3;
        }
        return 2;
    }
    return 1;
}

- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    //商铺信息
    if (section == 1){
        UIView *headView = [[UIView alloc] init];
        headView.frame = CGRectMake(0, 0, WIDTH, 48 + 8);
        headView.backgroundColor = TCBgColor;
        //店铺View
        UIView *shopheadView = [[UIView alloc] init];
        shopheadView.frame = CGRectMake(8, 8, WIDTH - 16, 48);
        shopheadView.backgroundColor = TCUIColorFromRGB(0xFFFFFF);
        [headView addSubview:shopheadView];
        //店铺的图片
       UIImageView *shopImage = [[UIImageView alloc] init];
//         [shopImage sd_setImageWithURL:[NSURL URLWithString:self.orderDisDic[@"headPic"]] placeholderImage:[UIImage imageNamed:@"商品详情页占位"]];
        //从再来一单进来的
        if (self.agianDic){
            [shopImage sd_setImageWithURL:[NSURL URLWithString:self.agianDic[@"shop"][@"headPic"]] placeholderImage:[UIImage imageNamed:@"商品详情页占位"]];
        } else {
            //团购和普通订单
            if ([self.typeStr isEqualToString:@"1"]){
                shopImage.image = [UIImage imageNamed:@"167"];
            } else {
            [shopImage sd_setImageWithURL:[NSURL URLWithString:self.orderDisDic[@"data"][@"headPic"]] placeholderImage:[UIImage imageNamed:@"商品详情页占位"]];
            }
        }
        
        shopImage.frame = CGRectMake(8, (48 - 24)/2, 24, 24);
        shopImage.layer.cornerRadius = 2;
        shopImage.layer.masksToBounds = YES;
        [shopheadView addSubview:shopImage];
        
        //店铺名称
        UILabel *shopTitleLabel = [UILabel publicLab:nil textColor:TCUIColorFromRGB(0x333333) textAlignment:NSTextAlignmentLeft fontWithName:@"PingFangSC-Regular" size:14 numberOfLines:0];
        //团购和普通订单
        if (self.agianDic){
            shopTitleLabel.text = self.agianDic[@"shop"][@"name"];
        } else {
            //从再来一单进来的
            if ([self.typeStr isEqualToString:@"1"]) {
                //团购
                shopTitleLabel.text = @"顺道嘉团购";
            } else {
                shopTitleLabel.text = self.orderDisDic[@"data"][@"name"];
            }
        }
       
        shopTitleLabel.frame = CGRectMake(CGRectGetMaxX(shopImage.frame) + 8, 0, WIDTH - 12 - (CGRectGetMaxX(shopImage.frame) + 8), 48);
        [shopheadView addSubview:shopTitleLabel];
        
        return headView;
    } else if (section == 2){
        UIView *headView_two = [[UIView alloc] init];
        headView_two.frame = CGRectMake(0, 0, WIDTH, 3);
        headView_two.backgroundColor = TCBgColor;
        
        UIView *writhheadView = [[UIView alloc] init];
        writhheadView.frame = CGRectMake(8, 0, WIDTH - 16, 3);
        writhheadView.backgroundColor = TCUIColorFromRGB(0xFFFFFF);
        [headView_two addSubview:writhheadView];
        
        return headView_two;
    }
    return [[UIView alloc] init];
}

-(UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    if (section == 3){
        UIView *footerView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, self.view.qh_width, 40)];
        footerView.backgroundColor = TCBgColor;
        return footerView;
    }
    return [[UIView alloc] init];
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    if (section == 1){
        return 48 + 8;
    } else if (section == 2){
        return 1;
    }
    return 8;
}

- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    if (section == 3){
        return 40;
    }
    return 0.1;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    // 定义唯一标识
    static NSString *CellIdentifier = @"Cell";
    // 通过indexPath创建cell实例 每一个cell都是单独的
    UITableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    if (!cell) {
        cell = [[UITableViewCell alloc]initWithStyle:UITableViewCellStyleSubtitle reuseIdentifier:CellIdentifier];
    }
    cell.backgroundColor = TCBgColor;
    cell.selectionStyle=UITableViewCellSelectionStyleNone;//设置cell点击效果
    
    if (indexPath.section == 0){
        //选择收货地址
        NSString *typeStr;
        if (self.listGroup == YES || [self.typeStr isEqualToString:@"1"]){
            typeStr = @"1";
        } else if (self.agianDic){
            typeStr = [NSString stringWithFormat:@"%@",self.agianDic[@"type"]];
        } else {
            typeStr = [NSString stringWithFormat:@"%@",self.orderDisDic[@"data"][@"type"]];
        }
        TCSeleAdressTableViewCell *adresscell = [[TCSeleAdressTableViewCell alloc]initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@"adresscell" andDic:self.adressDic andType:typeStr];
        
        adresscell.selectionStyle = UITableViewCellSelectionStyleNone;
        adresscell.delegate = self;
        adresscell.locationImage.frame = CGRectMake(8,(adresscell.clickView.frame.size.height - 20)/2 , 14, 16);
        adresscell.backgroundColor = TCBgColor;
       
        return adresscell;
    } else if (indexPath.section == 1){
        //店铺信息
        TCOrderGoodsTableViewCell *Goodscell = [[TCOrderGoodsTableViewCell alloc]initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@"Goodscell"];
        
        if (self.shopGoodsArray.count == 0){
            NSLog(@"无");
        } else {
            TCGoodsInfo *model = self.shopGoodsArray[indexPath.row];
            Goodscell.model = model;
        }
        Goodscell.selectionStyle = UITableViewCellSelectionStyleNone;
        Goodscell.backgroundColor = TCBgColor;
        return Goodscell;
    } else if (indexPath.section == 2){

        UIView *backView = [[UIView alloc] init];
        backView.backgroundColor = TCUIColorFromRGB(0xFFFFFF);
        backView.frame = CGRectMake(8, 0, WIDTH - 16, 46);
        backView.userInteractionEnabled = YES;
        [cell addSubview:backView];
        
        //满减的小框
        UILabel *specialLabel = [UILabel publicLab:nil textColor:TCUIColorFromRGB(0xFFFFFF) textAlignment:NSTextAlignmentCenter fontWithName:@"PingFangSC-Regular" size:10 numberOfLines:0];
        specialLabel.frame = CGRectMake(8, (46 - 14)/2, 14, 14);
        specialLabel.layer.cornerRadius = 4;
        specialLabel.layer.masksToBounds = YES;
        specialLabel.backgroundColor = TCUIColorFromRGB(0xF99E20);
        [backView addSubview:specialLabel];
        //title
        UILabel *titlespLabel = [UILabel publicLab:nil textColor:TCUIColorFromRGB(0x666666) textAlignment:NSTextAlignmentLeft fontWithName:@"PingFangSC-Regular" size:14 numberOfLines:0];
        titlespLabel.frame = CGRectMake(CGRectGetMaxX(specialLabel.frame) + 8, 0, 56, 46);
        [backView addSubview:titlespLabel];
        
        //价格
        UILabel *priceLabel = [UILabel publicLab:nil textColor:TCUIColorFromRGB(0x333333) textAlignment:NSTextAlignmentRight fontWithName:@"PingFangSC-Regular" size:14 numberOfLines:0];
        
        priceLabel.frame = CGRectMake(CGRectGetMaxX(titlespLabel.frame), 0, WIDTH - 16 - 8 - (CGRectGetMaxX(titlespLabel.frame)), 46);
        [backView addSubview:priceLabel];
        
        CGFloat x = 0.0;
        int y = 0;
        CGFloat h = 0.0;
        CGFloat m = 0.0; //满减优惠的
        int k = 0;
        
        //订单详情接口是真的好用
        if (self.agianDic){
            NSArray *agianArr = self.agianDic[@"goods"];
            //获取商品的总价格
            for (int i = 0; i < agianArr.count ; i++) {
                float price = 0.0;
                if ([agianArr[i][@"spec"] isEqualToString:@""]) {
                    price = [agianArr[i][@"price"] floatValue];
                } else {
                    price = [agianArr[i][@"new_price"] floatValue];
                }
                x += [agianArr[i][@"amount"] floatValue] * price;
                y += [agianArr[i][@"amount"] intValue];
                k = agianArr.count;
            }
        } else {   //这里是普通的商品和团购的
            
            //获取商品的总价格
            for (int i = 0; i < self.shopArr.count ; i++) {
                float price = 0.0;
                if ([self.shopArr[i][@"shopSpec"] isEqualToString:@""]) {
                    price = [self.shopArr[i][@"shopPrice"] floatValue];
                } else {
                    price = [self.shopArr[i][@"shopSpecPrice"] floatValue];
                }
                x += [self.shopArr[i][@"shopCount"] floatValue] * price;
                y += [self.shopArr[i][@"shopCount"] intValue];
                k = self.shopArr.count;
            }
        }
        NSString *peisongStr = self.orderDisDic[@"data"][@"distributionPrice"];
        h = [peisongStr floatValue];
        //有满减优惠
        NSString *manjianStr;
        if (self.activeArr.count != 0){
            manjianStr = self.activeArr[0][@"reduce"];  //满减的价格
        } else {
            NSLog(@"暂时未知");
            manjianStr = @"0";
        }

        m = [manjianStr floatValue];
        NSString *allPrice = [NSString stringWithFormat:@"%.2f", x+h-m];
        
        //总计
         UILabel *totalPricelabel = [UILabel publicLab:nil textColor:TCUIColorFromRGB(0x333333) textAlignment:NSTextAlignmentRight fontWithName:@"PingFangSC-Medium" size:16 numberOfLines:0];
        totalPricelabel.text = [NSString stringWithFormat:@"总计：¥%@",allPrice];
        totalPricelabel.frame =CGRectMake(0, 8, WIDTH - 16 - 8, 16);
        NSString *str;
        str = [NSString stringWithFormat:@"%@",totalPricelabel.text];
        [self fuwenbenLabel:totalPricelabel FontNumber:[UIFont fontWithName:@"PingFangSC-Medium" size:16] AndRange:NSMakeRange(3, str.length - 3) AndColor:TCUIColorFromRGB(0xFF3355)];
        [backView addSubview:totalPricelabel];
        
        //商品的数量
        UILabel *numGoodsLabel = [UILabel publicLab:[NSString stringWithFormat:@"%@种商品共计%@件",nil,nil] textColor:TCUIColorFromRGB(0x999999) textAlignment:NSTextAlignmentRight fontWithName:@"PingFangSC-Regular" size:12 numberOfLines:0];
        numGoodsLabel.text = [NSString stringWithFormat:@"%@种商品共计%@件",[NSString stringWithFormat:@"%d",k],[NSString stringWithFormat:@"%d",y]];
        numGoodsLabel.frame =CGRectMake(0, CGRectGetMaxY(totalPricelabel.frame) + 8, WIDTH - 16 - 8, 12);
        [backView addSubview:numGoodsLabel];
        
        //商超里面的有活动还有红包
        if (self.hongbaoArray.count != 0 && self.activeArr.count != 0){
            if (indexPath.row == 0){
                specialLabel.text = @"减";
                titlespLabel.text = self.activeArr[0][@"type_name"];
                priceLabel.text = [NSString stringWithFormat:@"¥%@",self.activeArr[0][@"reduce"]];
                totalPricelabel.hidden = YES;
                numGoodsLabel.hidden = YES;
            } else if (indexPath.row == 1){
                specialLabel.hidden = YES;
                titlespLabel.text = @"配送费";
                titlespLabel.font = [UIFont fontWithName:@"PingFangSC-Regular" size:14];
                
                titlespLabel.frame = CGRectMake(8, 0, 46, 46);
                //团购或者商超
                if (self.listGroup == YES){
                    priceLabel.text = [NSString stringWithFormat:@"¥%@",self.disPriceStr];
                } else {
                    if (self.agianDic){
                        priceLabel.text = [NSString stringWithFormat:@"¥%@",self.agianDic[@"distributionPrice"]];
                    } else {
                        priceLabel.text = [NSString stringWithFormat:@"¥%@",self.orderDisDic[@"data"][@"distributionPrice"]];
                    }
                }
                totalPricelabel.hidden = YES;
                numGoodsLabel.hidden = YES;
            } else if (indexPath.row == 2){
                specialLabel.hidden = YES;
                titlespLabel.frame = CGRectMake(8, 0, 46, 46);
                titlespLabel.text  =@"红包";
                totalPricelabel.hidden = YES;
                numGoodsLabel.hidden = YES;
            } else if (indexPath.row == 3){
                NSLog(@"总计");
                specialLabel.hidden = YES;
                titlespLabel.hidden = YES;
                totalPricelabel.hidden = NO;
                numGoodsLabel.hidden = NO;
                priceLabel.hidden = YES;
                backView.frame = CGRectMake(8, 0, WIDTH - 16, 68);
            }
        } else if (self.hongbaoArray.count == 0 && self.activeArr.count != 0){
            if (indexPath.row == 0){
                specialLabel.text = @"减";
                titlespLabel.text = self.activeArr[0][@"type_name"];
                priceLabel.text = [NSString stringWithFormat:@"¥%@",self.activeArr[0][@"reduce"]];
                totalPricelabel.hidden = YES;
                numGoodsLabel.hidden = YES;

            } else if (indexPath.row == 1){
                specialLabel.hidden = YES;
                titlespLabel.frame = CGRectMake(8, 0, 46, 46);
                titlespLabel.font = [UIFont fontWithName:@"PingFangSC-Regular" size:14];
                titlespLabel.text = @"配送费";
                
                //团购
                if (self.listGroup == YES){
                    priceLabel.text = [NSString stringWithFormat:@"¥%@",self.disPriceStr];
                } else {
                    if (self.agianDic){
                        priceLabel.text = [NSString stringWithFormat:@"¥%@",self.agianDic[@"distributionPrice"]];
                    } else {
                        priceLabel.text = [NSString stringWithFormat:@"¥%@",self.orderDisDic[@"data"][@"distributionPrice"]];
                    }
                }
                totalPricelabel.hidden = YES;
                numGoodsLabel.hidden = YES;

            } else if (indexPath.row == 2){
                NSLog(@"总计");
                specialLabel.hidden = YES;
                titlespLabel.hidden = YES;
                totalPricelabel.hidden = NO;
                numGoodsLabel.hidden = NO;
                priceLabel.hidden = YES;
                backView.frame = CGRectMake(8, 0, WIDTH - 16,  68);
            }
        } else if (self.hongbaoArray.count != 0 && self.activeArr.count == 0){
            if (indexPath.row == 0){
                specialLabel.hidden = YES;
                titlespLabel.frame = CGRectMake(8, 0, 46, 46);
                titlespLabel.text = @"红包";
                totalPricelabel.hidden = YES;
                numGoodsLabel.hidden = YES;
            } else if (indexPath.row == 1){
                specialLabel.hidden = YES;
                titlespLabel.frame = CGRectMake(8, 0, 46, 46);
                titlespLabel.text = @"配送费";
                titlespLabel.font = [UIFont fontWithName:@"PingFangSC-Regular" size:14];
                //团购
                if (self.listGroup == YES){
                    priceLabel.text = [NSString stringWithFormat:@"¥%@",self.disPriceStr];
                } else {
                    if (self.agianDic){
                        priceLabel.text = [NSString stringWithFormat:@"¥%@",self.agianDic[@"distributionPrice"]];
                    } else {
                        priceLabel.text = [NSString stringWithFormat:@"¥%@",self.orderDisDic[@"data"][@"distributionPrice"]];
                    }
                }
                totalPricelabel.hidden = YES;
                numGoodsLabel.hidden = YES;

            } else if (indexPath.row == 2){
                NSLog(@"总计");
                specialLabel.hidden = YES;
                titlespLabel.hidden = YES;
                totalPricelabel.hidden = NO;
                numGoodsLabel.hidden = NO;
                priceLabel.hidden = YES;
                backView.frame = CGRectMake(8, 0, WIDTH - 16, 68);
            }
        } else if (self.hongbaoArray.count == 0 && self.activeArr.count == 0){
            if (indexPath.row == 0){
                specialLabel.hidden = YES;
                titlespLabel.frame = CGRectMake(8, 0, 46, 46);
                titlespLabel.text = @"配送费";
                titlespLabel.font = [UIFont fontWithName:@"PingFangSC-Regular" size:14];
                //团购
                if (self.listGroup == YES){
                    priceLabel.text = [NSString stringWithFormat:@"¥%@",self.disPriceStr];
                } else {
                    if (self.agianDic){
                        priceLabel.text = [NSString stringWithFormat:@"¥%@",self.agianDic[@"distributionPrice"]];
                    } else {
                        priceLabel.text = [NSString stringWithFormat:@"¥%@",self.orderDisDic[@"data"][@"distributionPrice"]];
                    }
                }
                totalPricelabel.hidden = YES;
                numGoodsLabel.hidden = YES;

            } else {
                NSLog(@"总计");
                specialLabel.hidden = YES;
                titlespLabel.hidden = YES;
                totalPricelabel.hidden = NO;
                numGoodsLabel.hidden = NO;
                priceLabel.hidden = YES;
                backView.frame = CGRectMake(8, 0, WIDTH - 16,  68);
            }
        }
        return cell;
    } else if (indexPath.section == 3){
        TCPaymentTableViewCell *paymentscell = [[TCPaymentTableViewCell alloc]initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@"paymentscell"];
        //再来一单进来的
        if (self.agianDic){
            paymentscell.textView.text = self.agianDic[@"remark"];
            paymentscell.placLabel.hidden = YES;
        }
        paymentscell.delegate = self;
        paymentscell.selectionStyle = UITableViewCellSelectionStyleNone;
        paymentscell.backgroundColor = TCBgColor;
        return paymentscell;
    }
    
    return cell;
}
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section == 0){
        if (self.adressDic == nil){
            return 46 + 50;
        } else {
            return 46 + 90;
        }
    } else if (indexPath.section == 1){
        return 84;
    } else if (indexPath.section == 2){
        if (self.hongbaoArray.count != 0 && self.activeArr.count != 0){
            if (indexPath.row == 1 + self.activeArr.count + 1){
                return 68;
            } else {
                return 46;
            }
        } else if (self.hongbaoArray.count == 0 && self.activeArr.count != 0){
            if (indexPath.row == 2){
                return 68;
            } else {
                return 46;
            }
        } else if (self.hongbaoArray.count != 0 && self.activeArr.count == 0){
            if (indexPath.row == self.activeArr.count + 1){
                return 68;
            } else {
                return 46;
            }
        } else {
            if (indexPath.row == 1){
                return 68;
            } else {
                return 46;
            }
        }
    } else if (indexPath.section == 3){
        return 46 + 68;
    }
    return 46 + 50;
}


- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
}

#pragma mark -- 键盘上下滑
- (void)sendGlideValue
{
    NSTimeInterval animationDuration = 0.30f;
    [UIView beginAnimations:@ "ResizeForKeyboard" context:nil];
    [UIView setAnimationDuration:animationDuration];
    //恢复屏幕
    self.view.frame = CGRectMake(0.0f, 0.0f, self.view.frame.size.width, self.view.frame.size.height);
    [UIView commitAnimations];
    [self.view endEditing:YES];

}

- (void)upglideValue
{
    NSTimeInterval animationDuration = 0.30f;
    [UIView beginAnimations:@ "ResizeForKeyboard" context:nil];
    [UIView setAnimationDuration:animationDuration];
    //将视图的Y坐标向上移动，以使下面腾出地方用于软键盘的显示
    /*屏幕上移的高度，可以自己定*/
    self.view.frame = CGRectMake(0.0f,- 216 + 40, self.view.frame.size.width, self.view.frame.size.height);
    [UIView commitAnimations];
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    NSTimeInterval animationDuration = 0.30f;
    [UIView beginAnimations:@ "ResizeForKeyboard" context:nil];
    [UIView setAnimationDuration:animationDuration];
    //恢复屏幕
    self.view.frame = CGRectMake(0.0f, 0.0f, self.view.frame.size.width, self.view.frame.size.height);
    [UIView commitAnimations];
    [self.view endEditing:YES];
}

//设置不同字体颜色
-(void)fuwenbenLabel:(UILabel *)labell FontNumber:(id)font AndRange:(NSRange)range AndColor:(UIColor *)vaColor
{
    NSMutableAttributedString *str = [[NSMutableAttributedString alloc] initWithString:labell.text];
    
    //设置字号
    [str addAttribute:NSFontAttributeName value:font range:range];
    
    //设置文字颜色
    [str addAttribute:NSForegroundColorAttributeName value:vaColor range:range];
    
    labell.attributedText = str;
}

#pragma mark -- 选择地址
- (void)adressTap
{
    TCReaddressViewController *ReaddressVC = [[TCReaddressViewController alloc] init];
    
    ReaddressVC.typeStr = @"1";
    [self.navigationController pushViewController:ReaddressVC animated:YES];
}

#pragma mark -- 选择上门服务的时间
- (void)timeSecletTap:(NSString *)timeStrss
{
    NSLog(@"%@",timeStrss);
    self.timeStr = timeStrss;
}

#pragma mark -- 去支付
- (void)goPat:(UIButton *)sender
{
    NSLog(@"去支付");
    if (self.adressDic == nil){
        [TCProgressHUD showMessage:@"请选择您的地址"];
    } else {
        //上门服务
        NSString *typeStr = [NSString stringWithFormat:@"%@",self.orderDisDic[@"data"][@"type"]];
        if ([typeStr isEqualToString:@"2"]){
            [self creteOrder:typeStr];
        } else {
            //请求创建订单的接口
            [self creteOrder:self.typeStr];
        }
    }
}

//创建订单的接口
- (void)creteOrder:(NSString *)typeStr
{
    [ProgressHUD showHUDToView:self.view];
    NSString *midStr = [NSString stringWithFormat:@"%@",[self.userDefaults valueForKey:@"userID"]];
    NSString *tokenStr = [NSString stringWithFormat:@"%@",[self.userDefaults valueForKey:@"userToken"]];
    NSString *timeStr = [TCGetTime getCurrentTime];
    
    NSMutableArray *commitArr = [NSMutableArray array];
    NSDictionary *jsonDic;
    //从再来一单进来的
    if (self.agianDic){
        NSArray *arr = self.agianDic[@"goods"];
        if (arr.count)
        for (int i = 0; i < arr.count ; i++) {
            jsonDic = @{@"goodsid":arr[i][@"goodsid"], @"amount":arr[i][@"amount"], @"specid":arr[i][@"specid"]};
        }
        [commitArr addObject: jsonDic];
    } else {   //从团购和普通来的
        for (int i = 0; i < self.shopArr.count ; i++) {
            //无规格，订单传值0
            if ([typeStr isEqualToString:@"0"] || [typeStr isEqualToString:@"2"] ){ //普通商超的
                if ([self.shopArr[i][@"shopSpec"] isEqualToString:@""]) {
                    jsonDic = @{@"goodsid":self.shopArr[i][@"shopID"], @"amount":self.shopArr[i][@"shopCount"], @"specid":@"0"};
                } else {
                        //此处应传specID
                        jsonDic = @{@"goodsid":self.shopArr[i][@"shopID"], @"amount":self.shopArr[i][@"shopCount"], @"specid":@"0"};
                }
            } else {    //此处为团购的啊
                NSMutableArray *arr = [NSMutableArray array];
                for (NSDictionary *dict in self.shopArr) {
                    if (![dict[@"shopSpec"] isEqualToString:@""] && [dict[@"shopID"] isEqualToString:self.shopModel.shopGoodsID]) {
                        [arr addObject:dict];
                    }
                    jsonDic = @{@"goodsid":self.shopArr[i][@"shopID"], @"amount":self.shopArr[i][@"shopCount"], @"specid":self.shopArr[i][@"shopSpecID"]};
                }
            }
            [commitArr addObject: jsonDic];

        }
    }
    
    NSData *jsonData = [NSJSONSerialization dataWithJSONObject:commitArr options:NSJSONWritingPrettyPrinted error:nil];
    NSString *strs = [[NSString alloc]initWithData:jsonData encoding:NSUTF8StringEncoding];

    //好多判断
    //判断有无备注
    NSDictionary *messDic;
    NSDictionary *paramters;
    NSString *signStr;
    NSString *shopIDStr; // shopID
    //从再来一单进来
    if (self.agianDic){
        shopIDStr = self.agianDic[@"shopid"];
    } else {
        if (self.listGroup == YES){
            shopIDStr = self.shopIDStr;
        } else {
            shopIDStr = self.orderDisDic[@"data"][@"shopid"];
        }
    }
    if ([self.remarkStr isEqualToString:@""] || self.remarkStr == nil){
        //上门服务订单
        if ([typeStr isEqualToString:@"2"]){
            messDic = @{@"tillTime":self.timeStr,@"timestamp":timeStr,@"mid":midStr,@"token":tokenStr,@"shopid":shopIDStr,@"price":self.allP,@"goods":strs,@"deviceid":[TCGetDeviceId getDeviceId],@"addressid":self.adressDic[@"id"],@"type":typeStr};
            signStr = [TCServerSecret signStr:messDic];
            paramters = @{@"tillTime":self.timeStr,@"timestamp":timeStr,@"mid":midStr,@"token":tokenStr,@"shopid":shopIDStr,@"price":self.allP,@"goods":strs,@"deviceid":[TCGetDeviceId getDeviceId],@"addressid":self.adressDic[@"id"],@"type":typeStr,@"sign":signStr};
        } else {
            //商超订单
            messDic = @{@"timestamp":timeStr,@"mid":midStr,@"token":tokenStr,@"shopid":shopIDStr,@"price":self.allP,@"goods":strs,@"deviceid":[TCGetDeviceId getDeviceId],@"addressid":self.adressDic[@"id"],@"type":typeStr};
            signStr = [TCServerSecret signStr:messDic];
            paramters = @{@"timestamp":timeStr,@"mid":midStr,@"token":tokenStr,@"shopid":shopIDStr,@"price":self.allP,@"goods":strs,@"deviceid":[TCGetDeviceId getDeviceId],@"addressid":self.adressDic[@"id"],@"type":typeStr,@"sign":signStr};
        }
        } else {
            messDic = @{@"timestamp":timeStr,@"mid":midStr,@"token":tokenStr,@"shopid":shopIDStr,@"price":self.allP,@"goods":strs,@"remark":self.remarkStr,@"deviceid":[TCGetDeviceId getDeviceId],@"addressid":self.adressDic[@"id"],@"type":typeStr};
            signStr = [TCServerSecret signStr:messDic];
            paramters = @{@"timestamp":timeStr,@"mid":midStr,@"token":tokenStr,@"shopid":shopIDStr,@"price":self.allP,@"goods":strs,@"remark":self.remarkStr,@"deviceid":[TCGetDeviceId getDeviceId],@"addressid":self.adressDic[@"id"],@"type":typeStr,@"sign":signStr};
        
    }
    [TCNetworking postWithTcUrlString:[TCServerSecret loginAndRegisterSecretOffline:@"101009"] paramter:paramters success:^(NSString *jsonStr, NSDictionary *jsonDic) {
        NSLog(@"Dic = %@,Str = %@",jsonDic,jsonStr);
        NSString *codeStr = [NSString stringWithFormat:@"%@",jsonDic[@"code"]];
        NSString *orderidStr = [NSString stringWithFormat:@"%@",jsonDic[@"data"][@"orderid"]];
        if ([codeStr isEqualToString:@"1"]){
            TCShierViewController *shierVC = [[TCShierViewController alloc] init];
            shierVC.orderidStr = orderidStr;
            shierVC.priceGoods = self.allP;
            //如果从再来一单进去
            if (self.agianDic){
                shierVC.headImageStr = self.agianDic[@"shop"][@"headPic"];
                shierVC.shopName = self.agianDic[@"shop"][@"name"];
            } else{
                //团购或者商超
                shierVC.headImageStr = self.orderDisDic[@"data"][@"headPic"];
                shierVC.shopName = self.orderDisDic[@"data"][@"name"];
            }
            
            shierVC.rmakStr = self.remarkStr;
            shierVC.adressDic = self.adressDic;
            [self.navigationController pushViewController:shierVC animated:YES];
            
            //支付成功后清除购物车
            if ([typeStr isEqualToString:@"1"]){
                [self.groupDase deleteShops:shopIDStr];
            } else {
                [self.shopDase deleteShops:shopIDStr];
            }
        }
        
        [TCProgressHUD showMessage:jsonDic[@"msg"]];
        [ProgressHUD hiddenHUD:self.view];
    } failure:^(NSError *error) {
        nil;
    }];
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
