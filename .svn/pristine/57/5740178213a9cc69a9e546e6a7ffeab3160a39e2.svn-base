//
//  TCShopCarTableViewCell.m
//  顺道嘉(新)
//
//  Created by 某某 on 16/9/29.
//  Copyright © 2016年 Macx. All rights reserved.
//

#import "TCShopCarTableViewCell.h"
#import "TCShopSpecModel.h"


@implementation TCShopCarTableViewCell

- (id)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier andData:(NSDictionary *)dic andmodel:(TCShopModel *)model{
    if (self == [super initWithStyle:style reuseIdentifier:reuseIdentifier]) {
        _dics = dic;
        _database = [[TCShopDataBase alloc] initTCDataBase];
        _userdefaults = [NSUserDefaults standardUserDefaults];
        _model = model;
        [self create];
    }
    return self;
}

- (void)create{
    UILabel *lb = [[UILabel alloc]initWithFrame:CGRectMake(12, 0, 180 , 56 )];
    lb.text = _dics[@"shopName"];
    lb.font = [UIFont fontWithName:@"PingFangSC-Regular" size:14];
    lb.textColor = TCUIColorFromRGB(0x4C4C4C);
    lb.numberOfLines = 1;
    [self addSubview: lb];
    
    self.specLb = [[UILabel alloc] initWithFrame:CGRectMake(0, 0, 0, 0)];
    self.specLb.font = [UIFont systemFontOfSize:12];
    self.specLb.textColor = TCUIColorFromRGB(0x999999);
    [self addSubview:self.specLb];
    
    
    NSArray *specArr = _model.shopSpecs;
    TCShopSpecModel *SpecModels;
    for (int i = 0; i < specArr.count; i++) {
        TCShopSpecModel *SpecModel = specArr[i];
        if ([_dics[@"shopSpec"] isEqualToString:SpecModel.shopSpecID]) {
            SpecModels = specArr[i];
        }
    }
    
    if ([_dics[@"shopSpec"] isEqualToString:@""]) {
        lb.frame = CGRectMake(12, 0, 180 , 56);
        self.specLb.hidden = YES;
    } else {
        self.specLb.hidden = NO;
        lb.frame = CGRectMake(12, 10, 180, 14);
        self.specLb.frame = CGRectMake(12,  14 + 15, 180, 12);
        self.specLb.text = SpecModels.shopSpecName;
    }
    
    UIButton *add = [[UIButton alloc]initWithFrame:CGRectMake(WIDTH - 10 - 24 , 28 - 12, 24 , 24)];
    [add setImage:[UIImage imageNamed:@"加商品"] forState:UIControlStateNormal];
    [add addTarget:self action:@selector(add) forControlEvents:UIControlEventTouchUpInside];
    [self addSubview: add];
    
    _lb2 = [[UILabel alloc]initWithFrame:CGRectMake(add.frame.origin.x - 40, add.frame.origin.y, 40 , add.frame.size.height)];
    _lb2.text = _dics[@"shopCount"];
    _lb2.font = [UIFont fontWithName:@"PingFangTC-Semibold" size:15];
    _lb2.textColor = TCUIColorFromRGB(0x333333);
    _lb2.textAlignment = NSTextAlignmentCenter;
    [self addSubview: _lb2];
    
    UIButton *cut = [[UIButton alloc]initWithFrame:CGRectMake(_lb2.frame.origin.x - 24 , _lb2.frame.origin.y, 24 , 24 )];
    [cut setImage:[UIImage imageNamed:@"减号按钮"] forState:UIControlStateNormal];
    [cut addTarget:self action:@selector(cut) forControlEvents:UIControlEventTouchUpInside];
    [self addSubview: cut];
    
    UILabel *lb3 = [[UILabel alloc]initWithFrame:CGRectMake(lb.frame.origin.x + lb.frame.size.width + 10 , 0, cut.frame.origin.x - lb.frame.origin.x - lb.frame.size.width - 10 , 56 )];
    lb3.font = [UIFont fontWithName:@"PingFangSC-Medium" size:16];
    lb3.textAlignment = NSTextAlignmentCenter;
    lb3.textColor = TCUIColorFromRGB(0xFF3355);
    if ([_dics[@"shopSpec"] isEqualToString:@""]) {
        lb3.text = [NSString stringWithFormat:@"¥%@", _dics[@"shopPrice"]];
    } else {
        lb3.text = [NSString stringWithFormat:@"¥%@", _dics[@"shopSpecPrice"]];
    }
    
    [self addSubview: lb3];
}

- (void)bianliSQL:(SQLBlock)sql{
    _sqlBlock = sql;
}

- (void)reloadTableview:(reloadBlock)reload{
    _block = reload;
}
//添加
- (void)add{
    if ([_lb2.text intValue] + 1 > [_dics[@"shopStockCount"] intValue]) {
        [TCProgressHUD showMessage:@"超出库存量啦!"];
    }else{
        _lb2.text = [NSString stringWithFormat:@"%d", [_lb2.text intValue] + 1];
        //判断是否有规
        
        [_database upDateFMDB:_model.shopStoreID andShopid:_model.shopGoodsID andcount:_lb2.text andSpec:_dics[@"shopSpec"] andModel:_model andSpecPrice:_dics[@"shopSpecPrice"]];
        _sqlBlock();//要求之前页面遍历数据库
    }
}

//减少
- (void)cut{
    _lb2.text = [NSString stringWithFormat:@"%d", [_lb2.text intValue] - 1];
    [_database upDateFMDB:_model.shopStoreID andShopid:_model.shopGoodsID andcount:_lb2.text andSpec:_dics[@"shopSpec"] andModel:_model andSpecPrice:_dics[@"shopSpecPrice"]];
    _sqlBlock();//要求之前页面遍历数据库
    
    //当减到0 的时候  tableview中移除刚数据
    if ([_lb2.text intValue] == 0) {
        _block();//要求之前页面刷新tableview
    }
}


@end
